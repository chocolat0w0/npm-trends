# 詳細仕様: npm-trends

## プロダクト概要

- 目的: 公式 npm / npmtrends.com で把握できない複数パッケージの年間ダウンロード数を可視化する。
- 対象: ライブラリ採用判断を急ぐフロントエンド / Node.js エンジニア。

## ユーザーストーリー

- 開発者として、比較したい npm パッケージ名を 1 件以上入力してダウンロード数を照らし合わせたい。
- 開発者として、不要になったパッケージを削除してグラフを見やすく保ちたい。
- 開発者として、パッケージが存在しない場合に即座にエラーを受け取り、入力ミスを修正したい。

## 機能要件

1. **パッケージ入力フォーム**
   - 常に表示されるラベル付き入力「Package name」を提供する。
   - 複数回の送信を受け付け、送信前に trim + 小文字化で正規化する。
   - 重複は無視して同じパッケージを二重追加しない。
2. **データ取得**
   - 送信された各パッケージに対し `GET https://api.npmjs.org/downloads/range/last-year/<package>` を呼び出す。
   - レスポンス `{downloads: [{day, downloads}], start, end}` を解析し、日付と値の配列を生成する。
   - `{ "error":"package <name> not found" }` を受け取った場合はインラインアラートを表示し、グラフ更新をスキップする。
   - 入力中の連続送信を防ぐため 300ms 程度のデバウンスを挟む。
3. **ビジュアライゼーション**
   - 過去 365 日を対象としたレスポンシブな折れ線グラフを描画する。
   - パッケージごとに高コントラストな固有色を割り当て、凡例・ホバーツールチップ（日付＋値）を表示する。
   - パッケージ未追加時は折れ線が存在しないグラフ枠のみ表示される。
4. **パッケージ管理 UI**
   - 選択中パッケージをカラーラベル付きチップ／カードで一覧し、直近ダウンロード概況を添える。
   - 各チップには削除操作を設け、削除時にデータセットを破棄してグラフを再描画する。
5. **エラー・ローディング状態**
   - API 待機中はパッケージ単位のローディングインジケーターを表示する。
   - 通信失敗時はリトライ付きの全体バナーで通知する。
6. **URL クエリ連携**
   - 現在の比較対象を `?packages=react,vue` のように URL クエリへ反映する。履歴・共有のため localStorage 等へ保存する必要はない。
   - 画面初期化時にクエリを解析し、記載パッケージを自動取得してグラフへ描画する。
   - クエリ内のパッケージは入力フォームと同じ正規化ロジックを適用し、存在しないパッケージはエラーとしてスキップする。

## 技術アーキテクチャ

- フロントエンド: React + TypeScript (Vite)。関数コンポーネントとフック、Context でチャート状態を共有する。
- データ層: `src/services/npmClient.ts` で型付き `DownloadSeries` を返し、パッケージ名キーでメモリキャッシュする。
- 状態管理: Zustand で `packages`, `status`, `errors` を追跡する。
- 可視化: Recharts を `DownloadChart` コンポーネントにラップして利用する。

## UI/UX 仕様

- レイアウト: デスクトップでは左に入力＋パッケージ一覧、右にグラフ。モバイルでは入力を上、グラフを下に縦積み。
- バリデーション: 入力が空のときは送信ボタンを無効化し、フォーマット誤りにはヘルパーテキストを表示する。
- アクセシビリティ: グラフへ説明的な `aria-label` を付け、フォーカス順序を文書フローに合わせ、色は WCAG 4.5:1 を満たしつつパターン表示で色覚多様性に対応する。

## テストと指標

- npm クライアント、リデューサ、チャート変換ロジックを Vitest で単体テストする。
- 複数パッケージ操作、削除動作、エラーレンダリングを Testing Library で結合テストする。
- 可能であれば凡例周りのスナップショットまたはビジュアルリグレッションテストを追加する。
- ステートメントカバレッジ 80% 以上を維持し、CI で Vitest のカバレッジゲートを有効化する。

## 決定事項（旧オープンクエスチョン）

- **状態保持方法**: 結果は URL クエリへシリアライズすることで共有・復元し、ブラウザストレージへは保存しない。
- **表示上限**: 同時表示パッケージ数に上限は設けず、凡例と配色の工夫で視認性を確保する。
